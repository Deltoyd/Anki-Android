---
phase: 01-puzzle-assembly-fix
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
autonomous: false

must_haves:
  truths:
    - "Corner pieces appear at exactly the four grid corners (0,0), (0,9), (9,0), (9,9)"
    - "Border pieces alternate between variant 1 and variant 2 along each edge using (row+col) % 2"
    - "Interior pieces alternate between variant 1 and variant 2 in a checkerboard pattern using (row+col) % 2"
    - "When all pieces are locked, the visual result is one cohesive gray puzzle with tabs meeting holes"
  artifacts:
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt"
      provides: "Updated pieceBitmaps map (14 entries) and getPieceType() with variant alternation"
      contains: "border_top_1"
  key_links:
    - from: "getPieceType(row, col)"
      to: "pieceBitmaps map"
      via: "String key lookup -- getPieceType returns keys that must exactly match pieceBitmaps map keys"
      pattern: "pieceBitmaps\\[pieceType\\]"
    - from: "pieceBitmaps map keys"
      to: "R.drawable.puzzle_* resources"
      via: "BitmapFactory.decodeResource -- map values must reference existing drawable resource names"
      pattern: "R\\.drawable\\.puzzle_"
    - from: "(row + col) % 2"
      to: "variant suffix (_1 or _2)"
      via: "Checkerboard alternation in getPieceType when expression"
      pattern: "\\(row \\+ col\\) % 2"
---

<objective>
Update PaintingPuzzleView.kt to load all 14 new puzzle piece drawables and alternate border/interior variants using (row+col) % 2 checkerboard pattern.

Purpose: The pieceBitmaps map currently references 9 old piece types (no variants). The getPieceType() function returns single types without alternation. Both must be updated so that locked pieces display with proper tab/hole interlocking -- every piece's tabs meet its neighbor's holes.

Output: Updated PaintingPuzzleView.kt with 14-entry pieceBitmaps map and variant-aware getPieceType() function.
</objective>

<execution_context>
@/Users/rolandharper/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rolandharper/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-puzzle-assembly-fix/01-RESEARCH.md
@.planning/phases/01-puzzle-assembly-fix/01-01-SUMMARY.md
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pieceBitmaps map and getPieceType() for 14-piece variant system</name>
  <files>AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt</files>
  <action>
Make two changes to PaintingPuzzleView.kt:

**Change 1: Replace pieceBitmaps map (lines 47-59)**

Replace the existing 9-entry `pieceBitmaps` lazy map with a 14-entry version. The 4 corner keys stay the same. Border keys gain variant suffixes (_1, _2). Middle key gains variant suffix.

New map contents:
```kotlin
private val pieceBitmaps by lazy {
    mapOf(
        "corner_tl" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_corner_tl),
        "corner_tr" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_corner_tr),
        "corner_bl" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_corner_bl),
        "corner_br" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_corner_br),
        "border_top_1" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_top_1),
        "border_top_2" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_top_2),
        "border_bottom_1" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_bottom_1),
        "border_bottom_2" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_bottom_2),
        "border_left_1" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_left_1),
        "border_left_2" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_left_2),
        "border_right_1" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_right_1),
        "border_right_2" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_border_right_2),
        "middle_1" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_middle_1),
        "middle_2" to BitmapFactory.decodeResource(resources, R.drawable.puzzle_middle_2),
    )
}
```

CRITICAL: Map keys must exactly match the strings returned by getPieceType(). The naming convention is: corners = "corner_{tl|tr|bl|br}", borders = "border_{top|bottom|left|right}_{1|2}", interior = "middle_{1|2}".

**Change 2: Replace getPieceType() function (lines 422-436)**

Replace the existing getPieceType() that returns 9 fixed types with a variant-aware version using (row+col) % 2 checkerboard alternation. Per user decision: use (row+col) % 2 for standard jigsaw pattern.

New function:
```kotlin
private fun getPieceType(
    row: Int,
    col: Int,
): String =
    when {
        row == 0 && col == 0 -> "corner_tl"
        row == 0 && col == COLS - 1 -> "corner_tr"
        row == ROWS - 1 && col == 0 -> "corner_bl"
        row == ROWS - 1 && col == COLS - 1 -> "corner_br"
        row == 0 -> {
            val variant = if ((row + col) % 2 == 0) 1 else 2
            "border_top_$variant"
        }
        row == ROWS - 1 -> {
            val variant = if ((row + col) % 2 == 0) 1 else 2
            "border_bottom_$variant"
        }
        col == 0 -> {
            val variant = if ((row + col) % 2 == 0) 1 else 2
            "border_left_$variant"
        }
        col == COLS - 1 -> {
            val variant = if ((row + col) % 2 == 0) 1 else 2
            "border_right_$variant"
        }
        else -> {
            val variant = if ((row + col) % 2 == 0) 1 else 2
            "middle_$variant"
        }
    }
```

The corner cases have NO variant -- each corner has exactly one piece shape. Borders and interior pieces use (row+col) % 2 to alternate between variant 1 and variant 2, creating the checkerboard pattern where every tab meets a hole.

Do NOT modify any other functions. drawLockedPiecePng() already uses getPieceType() and pieceBitmaps correctly -- no changes needed there. PuzzlePiecePathGenerator must remain unchanged per user decision.
  </action>
  <verify>
1. Run: grep -c "BitmapFactory.decodeResource" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
   Expected: 14 (one per piece)

2. Run: grep "R.drawable.puzzle_" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
   Expected: 14 lines, all referencing new names (no puzzle_border_top without suffix, no puzzle_middle without suffix)

3. Run: grep "(row + col) % 2" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
   Expected: 5 occurrences (top border, bottom border, left border, right border, middle)

4. Run: grep "corner_tl\|corner_tr\|corner_bl\|corner_br" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
   Expected: 8 lines (4 in map + 4 in getPieceType)

5. Build check: ./gradlew :AnkiDroid:compilePlayDebugKotlin
   Expected: BUILD SUCCESSFUL (confirms R.drawable references resolve to actual files)
  </verify>
  <done>
pieceBitmaps map has 14 entries matching the 14 drawable resources. getPieceType() returns variant-suffixed keys using (row+col) % 2 for borders and interior, and fixed keys for the 4 corners. All map keys exactly match getPieceType() return values. Build compiles successfully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of assembled puzzle</name>
  <files>AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt</files>
  <action>
Build, install, and visually verify the puzzle display. Run: ./gradlew installPlayDebug

Then open the AnkiDroid app on the connected device/emulator and navigate to the Museum homescreen to inspect the locked puzzle grid.

What was built: Updated puzzle piece asset system with 14 new gray gradient PNGs and checkerboard variant alternation logic. The locked puzzle should now display as one cohesive gray jigsaw where every piece's tabs meet its neighbor's holes.
  </action>
  <verify>
Human visual inspection required. Verify the following on device:
1. Four corners (top-left, top-right, bottom-left, bottom-right) each display a distinct corner piece shape
2. Border pieces along each edge alternate between two variants -- adjacent border pieces should have complementary shapes (tabs meet holes)
3. Interior pieces alternate in a checkerboard pattern -- no two adjacent interior pieces should look identical
4. The overall visual result is one unified, cohesive gray puzzle that looks like a fully-assembled jigsaw
5. No gaps, overlaps, or misaligned tabs/holes between adjacent pieces
6. If any unlocked pieces exist, verify they still show the painting correctly through jigsaw-shaped clips (unlocked rendering should be unchanged)

Resume signal: Type "approved" if the puzzle looks correct, or describe any visual issues you see.
  </verify>
  <done>User confirms the locked puzzle displays as one cohesive, fully-assembled gray jigsaw with proper tab/hole interlocking between all adjacent pieces.</done>
</task>

</tasks>

<verification>
1. PaintingPuzzleView.kt compiles without errors (./gradlew :AnkiDroid:compilePlayDebugKotlin)
2. pieceBitmaps map has exactly 14 entries with keys matching getPieceType() output
3. getPieceType() uses (row+col) % 2 for all non-corner pieces
4. Corners map to fixed positions: (0,0)=tl, (0,9)=tr, (9,0)=bl, (9,9)=br
5. Visual: locked puzzle displays as cohesive gray jigsaw with proper interlocking
</verification>

<success_criteria>
- PaintingPuzzleView.kt builds successfully with all 14 R.drawable references resolving
- getPieceType() returns correct variant keys for all 100 grid positions
- User confirms visual result: unified gray puzzle with tabs meeting holes
- Unlocked piece rendering remains unchanged (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/01-puzzle-assembly-fix/01-02-SUMMARY.md`
</output>
