---
phase: 05-study-tracking
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StudyTrackingRepository.kt
  - AnkiDroid/src/test/java/com/ichi2/anki/ui/museum/StudyTrackingRepositoryTest.kt
autonomous: true

must_haves:
  truths:
    - "Repository computes daily card counts and capped study time from revlog"
    - "Streak count reflects consecutive study days with grace day consumption"
    - "Grace days accumulate at rate of 1 per 3 consecutive study days, max 5"
    - "Missing a day with 0 grace resets streak to 0"
    - "Intensity levels are relative to the user's personal daily average"
  artifacts:
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StudyTrackingRepository.kt"
      provides: "Study tracking data layer with streak, grace, time, and intensity"
      exports: ["StudyTrackingRepository", "DailyStudyData", "StreakInfo", "StudyIntensity"]
    - path: "AnkiDroid/src/test/java/com/ichi2/anki/ui/museum/StudyTrackingRepositoryTest.kt"
      provides: "Unit tests for all study tracking logic"
      min_lines: 100
  key_links:
    - from: "StudyTrackingRepository"
      to: "revlog table"
      via: "col.db.query SQL"
      pattern: "from revlog"
---

<objective>
Create the StudyTrackingRepository with TDD — a pure data layer that queries Anki's revlog table to compute daily study stats, streak counts with grace days, capped study time, and relative intensity levels.

Purpose: Phases 6 (streak widget) and 7 (heatmap views) both consume this data layer. Getting the algorithm right via TDD is critical because the grace day system has non-obvious edge cases (streak resets, grace accumulation limits, grace consumption on gaps).

Output: Tested StudyTrackingRepository.kt with all business logic, consumed by Plan 02 for ViewModel integration.
</objective>

<execution_context>
@/Users/rolandharper/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rolandharper/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-study-tracking/05-CONTEXT.md
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumPersistence.kt
@libanki/src/main/java/com/ichi2/anki/libanki/DB.kt
@libanki/src/main/java/com/ichi2/anki/libanki/sched/Scheduler.kt (lines 550-600 for revlog query pattern)
@AnkiDroid/src/main/java/com/ichi2/anki/services/NotificationService.kt (revlog.id > ? pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD — StudyTrackingRepository core logic</name>
  <files>
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StudyTrackingRepository.kt
    AnkiDroid/src/test/java/com/ichi2/anki/ui/museum/StudyTrackingRepositoryTest.kt
  </files>
  <action>
Build StudyTrackingRepository using RED-GREEN-REFACTOR cycles. The repository takes a lambda `queryRevlog: suspend () -> List<RevlogEntry>` for testability (in production, this queries `col.db`; in tests, it's a fake list).

**Data model (define in StudyTrackingRepository.kt):**

```kotlin
data class RevlogEntry(val id: Long, val timeMs: Int)
// id = review timestamp in ms (revlog.id), timeMs = time spent in ms (revlog.time)

data class DailyStudyData(
    val date: LocalDate,
    val cardsReviewed: Int,
    val studyTimeMs: Long,  // capped at 30_000ms per card
    val wasStudied: Boolean, // true if cardsReviewed >= 1
)

enum class DayStatus { STUDIED, GRACE_USED, NOT_STUDIED }

data class StreakInfo(
    val currentStreak: Int,
    val graceDaysAvailable: Int,
    val todayStatus: DayStatus,
)

enum class StudyIntensity { NONE, LEVEL_1, LEVEL_2, LEVEL_3, LEVEL_4, LEVEL_5 }
```

**Core methods:**

1. `getDailyStudyData(entries: List<RevlogEntry>, fromDate: LocalDate, toDate: LocalDate): Map<LocalDate, DailyStudyData>`
   - Groups revlog entries by date (midnight local time boundary)
   - Caps each entry's time at 30_000ms (30s cap per card decision)
   - Returns map with an entry for every date in range (empty days get cardsReviewed=0, wasStudied=false)

2. `calculateStreak(dailyData: Map<LocalDate, DailyStudyData>, today: LocalDate): StreakInfo`
   - Walk backward from today
   - Track consecutive study days and grace consumption
   - Grace accumulation: every 3 consecutive actual study days (not grace-used) earns 1 grace day, max 5
   - Grace consumption: if a day is not studied but grace > 0, consume 1 grace, streak continues
   - If a day is not studied and grace == 0, streak breaks — return streak count from today back to break point
   - If today is not studied, todayStatus = NOT_STUDIED (streak still counts up to yesterday, but no grace consumed for today since day is still in progress)

3. `calculateIntensity(cardsReviewed: Int, dailyAverage: Double): StudyIntensity`
   - If cardsReviewed == 0: NONE
   - Compute ratio = cardsReviewed / dailyAverage
   - LEVEL_1: ratio <= 0.5 (below half average)
   - LEVEL_2: ratio <= 1.0 (up to average)
   - LEVEL_3: ratio <= 1.5 (up to 1.5x average)
   - LEVEL_4: ratio <= 2.0 (up to 2x average)
   - LEVEL_5: ratio > 2.0 (above 2x average)
   - If dailyAverage is 0 and cardsReviewed > 0: LEVEL_5 (any study when no history = max)

4. `computeDailyAverage(dailyData: Map<LocalDate, DailyStudyData>): Double`
   - Average cards reviewed across ALL days in the map that have cardsReviewed > 0 (don't count zero-days in average)
   - Returns 0.0 if no study days exist

5. `getStudyTimeForPeriod(dailyData: Map<LocalDate, DailyStudyData>): Long`
   - Sum studyTimeMs across all days in the map

**TDD cycle approach:**

RED phase: Write tests first for each method. Test cases:
- getDailyStudyData: empty list, single review, multiple reviews same day, 30s cap, multi-day, boundary at midnight
- calculateStreak: no study history (streak=0), 1 day studied (streak=1), 3 days consecutive (streak=3, grace=1), missed day with grace (streak continues, grace decremented), missed day without grace (streak=0), max 5 grace days (15+ consecutive days, caps at 5), today not studied yet (streak based on yesterday)
- calculateIntensity: zero cards, below average, at average, above average, way above average, no history fallback
- computeDailyAverage: empty data, single day, multiple days, mix of studied and unstudied days

GREEN phase: Implement each method to pass tests.

REFACTOR phase: Clean up if needed, ensure all tests still pass.

**Revlog query method (production use, tested via integration):**

```kotlin
class StudyTrackingRepository {
    /**
     * Queries revlog for all reviews in date range.
     * revlog.id is timestamp in ms, revlog.time is review duration in ms.
     * Called within withCol {} block.
     */
    companion object {
        suspend fun queryRevlog(
            db: com.ichi2.anki.libanki.DB,
            fromDate: LocalDate,
            toDate: LocalDate,
        ): List<RevlogEntry> {
            val fromMs = fromDate.atStartOfDay(ZoneId.systemDefault()).toInstant().toEpochMilli()
            val toMs = toDate.plusDays(1).atStartOfDay(ZoneId.systemDefault()).toInstant().toEpochMilli()
            val entries = mutableListOf<RevlogEntry>()
            db.query("SELECT id, time FROM revlog WHERE id >= ? AND id < ?", fromMs, toMs).use { cursor ->
                while (cursor.moveToNext()) {
                    entries.add(RevlogEntry(id = cursor.getLong(0), timeMs = cursor.getInt(1)))
                }
            }
            return entries
        }
    }
}
```

**IMPORTANT:** Make all pure computation methods public and static-like (companion object or top-level functions) so tests can call them without needing a database. Only `queryRevlog` needs a DB instance.

Use `java.time.LocalDate` and `java.time.ZoneId` for date handling (midnight local time boundary per user decision). Do NOT use Anki's configurable "next day starts at" setting.
  </action>
  <verify>
Run: `./gradlew :AnkiDroid:testPlayDebugUnitTest --tests "com.ichi2.anki.ui.museum.StudyTrackingRepositoryTest"` — all tests pass.

Manual check: Verify test covers at minimum:
- 3+ tests for getDailyStudyData (empty, single, cap, multi-day)
- 5+ tests for calculateStreak (no history, simple, grace earn, grace consume, grace exhausted, today unstudied)
- 4+ tests for calculateIntensity (none, each level boundary, no-history fallback)
- 2+ tests for computeDailyAverage and getStudyTimeForPeriod
  </verify>
  <done>
StudyTrackingRepository.kt exists with all 5 methods. StudyTrackingRepositoryTest.kt has 14+ passing tests covering streak logic with grace days, daily aggregation with 30s cap, intensity levels relative to average, and edge cases (empty data, today not yet studied). All computations are pure functions testable without a database.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :AnkiDroid:testPlayDebugUnitTest --tests "com.ichi2.anki.ui.museum.StudyTrackingRepositoryTest"` — all tests green
2. Grep for `30_000` or `30000` in StudyTrackingRepository.kt — confirms 30s cap is implemented
3. Grep for `graceDays` in test file — confirms grace day accumulation and consumption are tested
4. Grep for `StudyIntensity` — confirms 5 levels + NONE are defined
5. No SharedPreferences imports in StudyTrackingRepository.kt — data is computed on-the-fly from revlog
</verification>

<success_criteria>
- StudyTrackingRepository computes all study data from revlog entries without caching
- Streak calculation handles grace day accumulation (1 per 3 consecutive) and consumption correctly
- Grace days capped at 5
- Study time per card capped at 30 seconds
- Intensity uses 5 levels relative to personal daily average
- All edge cases covered by passing unit tests
- Day boundary uses midnight local time (java.time.LocalDate)
</success_criteria>

<output>
After completion, create `.planning/phases/05-study-tracking/05-01-SUMMARY.md`
</output>
