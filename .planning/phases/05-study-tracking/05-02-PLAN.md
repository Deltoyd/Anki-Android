---
phase: 05-study-tracking
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
autonomous: true

must_haves:
  truths:
    - "MuseumViewModel loads streak data from revlog via StudyTrackingRepository"
    - "MuseumViewModel exposes streak count, grace days, and today's study time"
    - "SharedPreferences-based streak/extraLives calls are replaced by repository calls"
  artifacts:
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt"
      provides: "ViewModel with revlog-derived streak and study data"
      contains: "StudyTrackingRepository"
  key_links:
    - from: "MuseumViewModel.kt"
      to: "StudyTrackingRepository.kt"
      via: "function calls within withCol block"
      pattern: "StudyTrackingRepository"
    - from: "MuseumViewModel.kt"
      to: "revlog table"
      via: "StudyTrackingRepository.queryRevlog"
      pattern: "queryRevlog"
---

<objective>
Wire StudyTrackingRepository into MuseumViewModel, replacing the SharedPreferences-based streak and extraLives data with revlog-derived computations. Update MuseumUiState to expose streak, grace days, and study time for downstream Phase 6 consumption.

Purpose: The ViewModel is the bridge between the data layer (Plan 01) and the UI (Phase 6). This wiring ensures the homescreen displays accurate, revlog-derived streak data instead of the placeholder SharedPreferences values.

Output: MuseumViewModel loads study data on startup, MuseumUiState carries streak info for Phase 6.
</objective>

<execution_context>
@/Users/rolandharper/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rolandharper/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-study-tracking/05-CONTEXT.md
@.planning/phases/05-study-tracking/05-01-SUMMARY.md
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StudyTrackingRepository.kt
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumPersistence.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire StudyTrackingRepository into MuseumViewModel</name>
  <files>AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt</files>
  <action>
Update MuseumViewModel to load study data from revlog instead of SharedPreferences.

**1. Update MuseumUiState data class:**

Add new fields, remove `extraLives`:
```kotlin
data class MuseumUiState(
    // ... existing fields ...
    val streakDays: Int = 0,
    val graceDaysAvailable: Int = 0,    // replaces extraLives
    val todayStudyTimeMs: Long = 0,     // capped study time for today
    val todayCardsReviewed: Int = 0,    // cards reviewed today
    // ... keep painting, unlockedPieces, progressText, currentDeckName, galleryItems, activePageIndex, currentArtTitle
)
```

Remove `extraLives` field from MuseumUiState (was `val extraLives: Int = 3`). The grace day system replaces the old extra lives concept.

**2. Update `loadMuseumData` method:**

Replace:
```kotlin
val streakDays = MuseumPersistence.getStreakDays(context)
val extraLives = MuseumPersistence.getExtraLives(context)
```

With a `withCol {}` block that:
1. Queries revlog for the last 365 days (sufficient window for streak calculation):
   ```kotlin
   val today = LocalDate.now()
   val fromDate = today.minusDays(365)
   val entries = StudyTrackingRepository.queryRevlog(db, fromDate, today)
   ```
2. Computes daily data:
   ```kotlin
   val dailyData = StudyTrackingRepository.getDailyStudyData(entries, fromDate, today)
   ```
3. Computes streak:
   ```kotlin
   val streakInfo = StudyTrackingRepository.calculateStreak(dailyData, today)
   ```
4. Gets today's study time and card count:
   ```kotlin
   val todayData = dailyData[today]
   val todayTimeMs = todayData?.studyTimeMs ?: 0L
   val todayCards = todayData?.cardsReviewed ?: 0
   ```

Update the `_uiState.update` call:
```kotlin
_uiState.update {
    it.copy(
        streakDays = streakInfo.currentStreak,
        graceDaysAvailable = streakInfo.graceDaysAvailable,
        todayStudyTimeMs = todayTimeMs,
        todayCardsReviewed = todayCards,
        currentDeckName = currentDeckName,
    )
}
```

**3. Update `refreshData` method:**

Replace the SharedPreferences streak/extraLives load with the same revlog-based computation as loadMuseumData. Extract a private helper `loadStudyStats()` to avoid duplication:

```kotlin
private suspend fun loadStudyStats(): Triple<StreakInfo, Long, Int> {
    return withCol {
        val today = LocalDate.now()
        val fromDate = today.minusDays(365)
        val entries = StudyTrackingRepository.queryRevlog(db, fromDate, today)
        val dailyData = StudyTrackingRepository.getDailyStudyData(entries, fromDate, today)
        val streakInfo = StudyTrackingRepository.calculateStreak(dailyData, today)
        val todayData = dailyData[today]
        Triple(streakInfo, todayData?.studyTimeMs ?: 0L, todayData?.cardsReviewed ?: 0)
    }
}
```

Both `loadMuseumData` and `refreshData` call this helper.

**4. Do NOT remove MuseumPersistence streak methods yet.**

MuseumPersistence.getStreakDays and getExtraLives will no longer be called from MuseumViewModel, but keep the methods in MuseumPersistence for backward compatibility. They can be cleaned up in a future phase. Just remove the calls from MuseumViewModel.

**5. Add imports:**
- `import com.ichi2.anki.ui.museum.StudyTrackingRepository`
- `import java.time.LocalDate`
  </action>
  <verify>
1. Build: `./gradlew :AnkiDroid:compilePlayDebugKotlin` — compiles without errors
2. Grep MuseumViewModel.kt for `MuseumPersistence.getStreakDays` — should return 0 matches (removed)
3. Grep MuseumViewModel.kt for `MuseumPersistence.getExtraLives` — should return 0 matches (removed)
4. Grep MuseumViewModel.kt for `StudyTrackingRepository` — should return 3+ matches (queryRevlog, getDailyStudyData, calculateStreak)
5. Grep MuseumViewModel.kt for `graceDaysAvailable` — should appear in UiState and update call
  </verify>
  <done>
MuseumViewModel loads streak, grace days, study time, and cards reviewed from revlog via StudyTrackingRepository. MuseumUiState exposes graceDaysAvailable instead of extraLives. SharedPreferences-based streak reads are removed from the ViewModel. The data layer from Plan 01 is fully wired into the ViewModel for Phase 6 consumption.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :AnkiDroid:compilePlayDebugKotlin` — builds successfully
2. `./gradlew :AnkiDroid:testPlayDebugUnitTest --tests "com.ichi2.anki.ui.museum.StudyTrackingRepositoryTest"` — Plan 01 tests still pass
3. MuseumViewModel no longer references `MuseumPersistence.getStreakDays` or `MuseumPersistence.getExtraLives`
4. MuseumUiState contains `graceDaysAvailable`, `todayStudyTimeMs`, `todayCardsReviewed`
5. Study data flows: revlog -> StudyTrackingRepository -> MuseumViewModel -> MuseumUiState
</verification>

<success_criteria>
- MuseumViewModel computes streak data from revlog on load and refresh
- MuseumUiState exposes streak count, grace days available, today's study time, and today's card count
- SharedPreferences-based streak/extraLives no longer used in MuseumViewModel
- Project compiles successfully
- Plan 01 tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-study-tracking/05-02-SUMMARY.md`
</output>
