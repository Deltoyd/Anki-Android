---
phase: 03-transparent-locked-pieces
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
autonomous: false

must_haves:
  truths:
    - "User sees the masterpiece painting through all locked puzzle pieces"
    - "Locked pieces render at 80% opacity (semi-transparent gray overlay teasing the painting)"
    - "Unlocked pieces remain at full opacity (existing behavior unchanged)"
  artifacts:
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt"
      provides: "Transparent locked piece rendering with painting visible underneath"
      contains: "alpha = 204"
  key_links:
    - from: "drawLockedPiecePng()"
      to: "scaledBitmap (painting)"
      via: "saveLayer + DST_IN compositing draws painting clipped to piece shape, then semi-transparent PNG on top"
      pattern: "saveLayer.*drawBitmap.*alphaMaskPaint.*pieceBitmapPaint\\.alpha.*204"
---

<objective>
Make locked puzzle pieces semi-transparent so the masterpiece painting is visible underneath at 80% opacity.

Purpose: This is the final visual feature of v1.1 -- locked pieces currently show only opaque gray gradient PNGs. After this change, users see a tantalizing hint of the masterpiece through every locked piece, motivating them to study and unlock more.

Output: Modified `drawLockedPiecePng()` in PaintingPuzzleView.kt that renders the painting clipped to the piece shape first, then draws the gray PNG piece at 80% opacity on top.
</objective>

<execution_context>
@/Users/rolandharper/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rolandharper/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-shape-system-fix/02-01-SUMMARY.md
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add painting-through-locked-pieces rendering with 80% opacity overlay</name>
  <files>AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt</files>
  <action>
Modify `drawLockedPiecePng()` to render the painting underneath each locked piece at 80% opacity. The technique: draw the painting clipped to the piece shape first, then draw the gray PNG piece on top at 80% opacity (alpha = 204). The painting shows through the 20% transparency.

**Step-by-step implementation in `drawLockedPiecePng()`:**

1. After computing `destLeft/destTop/destRight/destBottom` and setting `tmpPieceRect` (keep all existing positioning math -- lines 478-500 are unchanged), replace the single `canvas.drawBitmap(bmp, null, tmpPieceRect, pieceBitmapPaint)` call with the following compositing sequence:

2. Create a `saveLayer` for the piece area:
   ```kotlin
   val layerRect = RectF(destLeft, destTop, destRight, destBottom)
   canvas.saveLayer(layerRect, null)
   ```

3. Draw the full painting bitmap (DST -- destination for compositing):
   ```kotlin
   scaledBitmap?.let {
       canvas.drawBitmap(it, puzzleRect.left, puzzleRect.top, null)
   }
   ```

4. Apply the PNG alpha mask using the existing `alphaMaskPaint` (DST_IN) to clip the painting to the piece shape:
   ```kotlin
   canvas.drawBitmap(bmp, null, tmpPieceRect, alphaMaskPaint)
   ```

5. Restore the layer (painting is now clipped to piece shape):
   ```kotlin
   canvas.restore()
   ```

6. Draw the gray PNG piece on top at 80% opacity:
   ```kotlin
   pieceBitmapPaint.alpha = 204
   canvas.drawBitmap(bmp, null, tmpPieceRect, pieceBitmapPaint)
   pieceBitmapPaint.alpha = 255
   ```

The full replacement for the draw call at line 501 becomes a saveLayer block (steps 2-5) followed by the semi-transparent PNG draw (step 6). The result: the 20% of the painting showing through the gray overlay creates the "teasing" effect.

**Important constraints:**
- Do NOT modify `drawPuzzlePiece()` or the unlocked piece rendering -- TRANS-02 requires unlocked pieces stay at full opacity
- Do NOT modify `drawPeekMode()` -- peek mode is separate
- The `pieceBitmapPaint.alpha` MUST be reset to 255 after drawing to avoid affecting subsequent pieces
- Use the existing `alphaMaskPaint` instance (already has PorterDuff.Mode.DST_IN configured)
- The painting bitmap reference is `scaledBitmap` and the painting origin is `puzzleRect.left, puzzleRect.top`
- Tabs should show the painting through them too (the saveLayer covers the full dest rect including tabs -- this is correct, no special tab handling needed)
  </action>
  <verify>
Build the project:
```bash
cd /Users/rolandharper/StudioProjects/Anki-Android && ./gradlew assemblePlayDebug 2>&1 | tail -5
```
Verify BUILD SUCCESSFUL. Then confirm the changes by checking:
1. `drawLockedPiecePng()` contains `saveLayer` and `alphaMaskPaint`
2. `drawLockedPiecePng()` contains `pieceBitmapPaint.alpha = 204`
3. `drawLockedPiecePng()` contains `pieceBitmapPaint.alpha = 255` (reset)
4. `drawPuzzlePiece()` unlocked branch is unchanged (no alpha changes)
  </verify>
  <done>
`drawLockedPiecePng()` renders painting clipped to piece shape underneath, then draws gray PNG at alpha 204 (80% opacity) on top, with alpha reset to 255 after. Unlocked piece rendering in `drawPuzzlePiece()` is completely untouched. Project compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of transparent locked pieces on device</name>
  <files>AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PaintingPuzzleView.kt</files>
  <action>
Install the debug APK and verify the transparent locked piece rendering on a real device. This is a visual checkpoint -- no code changes, only verification.

Run: `cd /Users/rolandharper/StudioProjects/Anki-Android && ./gradlew installPlayDebug`

Then present the following verification steps to the user.
  </action>
  <verify>
User visually confirms all of the following on device:
1. Install the debug APK on your device: `./gradlew installPlayDebug`
2. Open the Museum puzzle screen with a painting loaded
3. Verify locked pieces: you should see the masterpiece painting faintly visible through the gray gradient pieces (80% gray overlay, 20% painting showing through)
4. Verify the painting is visible through tabs as well as the body of each piece (no solid gray tabs)
5. Verify unlocked pieces: they should show the full painting at 100% opacity (no change from before)
6. If you have a mix of locked and unlocked pieces, confirm the visual distinction is clear -- unlocked pieces are vivid, locked pieces are mostly gray with a hint of the painting
  </verify>
  <done>User confirms locked pieces show painting underneath at 80% opacity, unlocked pieces remain at full opacity, and the visual effect is satisfactory on a real device.</done>
</task>

</tasks>

<verification>
Phase 3 success checks:
1. **TRANS-01**: Locked pieces render at 80% opacity -- painting is visible through all locked pieces (body + tabs)
2. **TRANS-02**: Unlocked pieces remain at full opacity -- no alpha changes in the unlocked rendering path
3. **No regression**: Peek mode, animations, piece positioning all work unchanged
4. **Build**: `./gradlew assemblePlayDebug` succeeds
</verification>

<success_criteria>
- The masterpiece painting is visible through every locked puzzle piece
- Locked pieces show gray gradient at 80% opacity over the painting (alpha = 204)
- Unlocked pieces render at full 100% opacity (untouched)
- Project builds successfully
- User visually confirms the effect on a real device
</success_criteria>

<output>
After completion, create `.planning/phases/03-transparent-locked-pieces/03-01-SUMMARY.md`
</output>
