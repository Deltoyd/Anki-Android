---
phase: 06-streak-widget-bottom-sheet
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AnkiDroid/src/main/res/layout/activity_museum.xml
  - AnkiDroid/src/main/res/layout/bottomsheet_streak.xml
  - AnkiDroid/src/main/res/values/colors.xml
  - AnkiDroid/src/main/res/values/strings.xml
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StreakBottomSheet.kt
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
  - AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt
autonomous: true

must_haves:
  truths:
    - "User sees a pill-shaped streak widget at top-left of homescreen showing 'Streak' label, day count, and fire icon"
    - "User taps the streak pill and a bottom sheet opens"
    - "User sees their current streak count (consecutive days studied) in the bottom sheet"
    - "User sees total study time in the bottom sheet"
  artifacts:
    - path: "AnkiDroid/src/main/res/layout/activity_museum.xml"
      provides: "Streak pill widget in top navigation bar"
      contains: "streakPill"
    - path: "AnkiDroid/src/main/res/layout/bottomsheet_streak.xml"
      provides: "Bottom sheet layout with streak count and study time"
      contains: "streakCount"
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StreakBottomSheet.kt"
      provides: "BottomSheetDialogFragment displaying streak data"
      contains: "class StreakBottomSheet"
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt"
      provides: "Click handler wiring streak pill to bottom sheet"
      contains: "streakPill"
  key_links:
    - from: "AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt"
      to: "StreakBottomSheet"
      via: "streakPill click listener shows bottom sheet"
      pattern: "streakPill.*setOnClickListener"
    - from: "StreakBottomSheet"
      to: "MuseumViewModel.uiState"
      via: "Collects streakDays and totalStudyTimeMs from shared ViewModel"
      pattern: "viewModel\\.uiState\\.collect"
    - from: "MuseumViewModel"
      to: "StudyTrackingRepository"
      via: "loadStudyStats computes totalStudyTimeMs from getStudyTimeForPeriod"
      pattern: "getStudyTimeForPeriod"
---

<objective>
Add streak pill widget to the homescreen toolbar and create a bottom sheet that displays the user's current streak count and total study time.

Purpose: Users need visible feedback on their study consistency (streak) and a way to see details (bottom sheet). The streak pill replaces the removed heatmap as the primary study motivation element.

Output: Pill widget in toolbar, bottom sheet with streak + study time, all wired to existing ViewModel data.
</objective>

<execution_context>
@/Users/rolandharper/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rolandharper/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-study-tracking/05-02-SUMMARY.md

Key references:
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
@AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt
@AnkiDroid/src/main/res/layout/activity_museum.xml
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StudyTrackingRepository.kt
@AnkiDroid/src/main/java/com/ichi2/anki/multimedia/MultimediaBottomSheet.kt (pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add streak pill to toolbar, streak colors, and bottom sheet layout</name>
  <files>
    AnkiDroid/src/main/res/layout/activity_museum.xml
    AnkiDroid/src/main/res/layout/bottomsheet_streak.xml
    AnkiDroid/src/main/res/values/colors.xml
    AnkiDroid/src/main/res/values/strings.xml
  </files>
  <action>
**1. Add streak pill widget to activity_museum.xml:**

In the Top Navigation Bar LinearLayout, insert a streak pill BEFORE the existing `languageSelector` button (so it appears at the far left). The pill should be a MaterialButton styled as an outlined pill:

```xml
<!-- Streak Pill (Left-most) -->
<com.google.android.material.button.MaterialButton
    android:id="@+id/streakPill"
    android:layout_width="wrap_content"
    android:layout_height="36dp"
    android:text="Streak 0 ðŸ”¥"
    android:textSize="13sp"
    android:textColor="@color/museolingo_streak_text"
    android:paddingStart="12dp"
    android:paddingEnd="12dp"
    style="@style/Widget.Material3.Button.TonalButton"
    app:backgroundTint="@color/museolingo_streak_pill_bg"
    app:cornerRadius="18dp"
    android:minWidth="0dp"
    android:minHeight="0dp"
    android:insetTop="0dp"
    android:insetBottom="0dp" />
```

Move the `languageSelector` button to come AFTER the streak pill. The layout order in the horizontal LinearLayout should be: streakPill, appTitle (weight=1 centered), menuButton. Remove the `languageSelector` from this bar since the deck selector was removed in Phase 4. If `languageSelector` is still referenced, keep it but move it to the right side or remove if no longer needed.

Actually, looking at the layout: the current order is languageSelector (left), appTitle (center, weight=1), menuButton (right). Replace languageSelector with streakPill. The streak pill goes at top-left. The deck selector still exists and is functional, so keep it. Revised approach: Insert streakPill BEFORE languageSelector. Order becomes: streakPill, languageSelector, appTitle (weight=1), menuButton.

Wait â€” the toolbar is already crowded. Better approach: Replace the appTitle position or restructure. Looking at the requirements: "User sees a pill-shaped streak widget at the top-left." The deck selector is also at the left. Best approach:

Insert streakPill as the FIRST child. Then languageSelector. Then appTitle (weight=1 center). Then menuButton (right).

The streak pill text format: "Streak {N} ðŸ”¥" â€” use a fire emoji in text. The pill background should use a warm tonal color from the #d36b52 family.

**2. Add streak colors to colors.xml:**

Add these colors in the MuseoLingo Palette section:

```xml
<!-- Streak colors (#d36b52 family per user spec) -->
<color name="museolingo_streak_pill_bg">#FFF0EC</color>
<color name="museolingo_streak_text">#D36B52</color>
<color name="museolingo_streak_accent">#D36B52</color>
<color name="museolingo_streak_accent_light">#E8998A</color>
```

`#FFF0EC` is a very light warm tint for the pill background. `#D36B52` is the user-specified primary streak color for text and accents.

**3. Add string resources to strings.xml:**

Add these strings in the museum/streak section (find an appropriate spot, or add at the end before closing `</resources>`):

```xml
<!-- Streak -->
<string name="streak_pill_format">Streak %d ðŸ”¥</string>
<string name="streak_bottom_sheet_title">Your Streak</string>
<string name="streak_days_format">%d days</string>
<string name="streak_total_study_time">Total Study Time</string>
<string name="streak_current_streak">Current Streak</string>
<string name="streak_grace_days">Grace Days</string>
<string name="streak_grace_days_format">%d remaining</string>
<string name="streak_time_hours_minutes">%dh %dm</string>
<string name="streak_time_minutes">%dm</string>
<string name="streak_time_seconds">%ds</string>
```

**4. Create bottomsheet_streak.xml layout:**

Create `AnkiDroid/src/main/res/layout/bottomsheet_streak.xml`. This is the content layout for the StreakBottomSheet. Design:

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical"
    android:padding="24dp"
    android:background="@color/museolingo_bg">

    <!-- Drag handle -->
    <View
        android:layout_width="40dp"
        android:layout_height="4dp"
        android:layout_gravity="center_horizontal"
        android:layout_marginBottom="16dp"
        android:background="@drawable/bottomsheet_handle" />

    <!-- Fire icon + streak count -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:gravity="center"
        android:orientation="vertical"
        android:paddingBottom="24dp">

        <TextView
            android:id="@+id/streakFireIcon"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="ðŸ”¥"
            android:textSize="48sp" />

        <TextView
            android:id="@+id/streakCount"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textSize="36sp"
            android:textColor="@color/museolingo_streak_accent"
            android:textStyle="bold"
            android:fontFamily="serif" />

        <TextView
            android:id="@+id/streakLabel"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/streak_current_streak"
            android:textSize="14sp"
            android:textColor="@color/museolingo_text_secondary" />

    </LinearLayout>

    <!-- Divider -->
    <View
        android:layout_width="match_parent"
        android:layout_height="1dp"
        android:background="@color/museolingo_text_secondary"
        android:alpha="0.2" />

    <!-- Stats row -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:paddingTop="20dp"
        android:paddingBottom="8dp">

        <!-- Total Study Time -->
        <LinearLayout
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:gravity="center"
            android:orientation="vertical">

            <TextView
                android:id="@+id/totalStudyTime"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:textSize="20sp"
                android:textColor="@color/museolingo_text"
                android:textStyle="bold" />

            <TextView
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/streak_total_study_time"
                android:textSize="12sp"
                android:textColor="@color/museolingo_text_secondary" />

        </LinearLayout>

        <!-- Grace Days -->
        <LinearLayout
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:gravity="center"
            android:orientation="vertical">

            <TextView
                android:id="@+id/graceDaysCount"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:textSize="20sp"
                android:textColor="@color/museolingo_text"
                android:textStyle="bold" />

            <TextView
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/streak_grace_days"
                android:textSize="12sp"
                android:textColor="@color/museolingo_text_secondary" />

        </LinearLayout>

    </LinearLayout>

    <!-- Placeholder for heatmap (Phase 7) -->
    <!-- This space will hold the Week/Month/Year tabs in Phase 7 -->

</LinearLayout>
```

For the drag handle drawable, check if `@drawable/bottomsheet_handle` exists. If not, create a simple shape drawable `AnkiDroid/src/main/res/drawable/bottomsheet_handle.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<shape xmlns:android="http://schemas.android.com/apk/res/android"
    android:shape="rectangle">
    <solid android:color="@color/museolingo_text_secondary" />
    <corners android:radius="2dp" />
    <size android:width="40dp" android:height="4dp" />
</shape>
```

If a handle drawable already exists in the project, use that instead. Check with `find . -name "*handle*" -path "*/drawable/*"`.
  </action>
  <verify>
    1. `grep -c "streakPill" AnkiDroid/src/main/res/layout/activity_museum.xml` returns 1+
    2. `test -f AnkiDroid/src/main/res/layout/bottomsheet_streak.xml` succeeds
    3. `grep "museolingo_streak" AnkiDroid/src/main/res/values/colors.xml | wc -l` returns 4
    4. `grep "streak_" AnkiDroid/src/main/res/values/strings.xml | wc -l` returns 8+
    5. `grep -c "streakCount" AnkiDroid/src/main/res/layout/bottomsheet_streak.xml` returns 1+
    6. `grep -c "totalStudyTime" AnkiDroid/src/main/res/layout/bottomsheet_streak.xml` returns 1+
  </verify>
  <done>
    Streak pill widget appears in activity_museum.xml toolbar at top-left position. Bottom sheet layout exists with fire icon, streak count, total study time, and grace days sections. Streak colors (#d36b52 family) defined in colors.xml. String resources for all streak text defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StreakBottomSheet fragment and wire into MuseumActivity</name>
  <files>
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StreakBottomSheet.kt
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
    AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt
  </files>
  <action>
**1. Add totalStudyTimeMs to MuseumUiState and loadStudyStats():**

In `MuseumViewModel.kt`:

- Add `val totalStudyTimeMs: Long = 0` to the `MuseumUiState` data class.

- In `loadStudyStats()`, change the return type from `Triple<StreakInfo, Long, Int>` to a data class or add a 4th value. Since Kotlin doesn't have Quadruple, create a small data class inside the ViewModel or return a dedicated result object. Simplest approach: compute totalStudyTimeMs and return it alongside. Use a local data class:

```kotlin
private data class StudyStats(
    val streakInfo: StreakInfo,
    val todayStudyTimeMs: Long,
    val todayCardsReviewed: Int,
    val totalStudyTimeMs: Long,
)
```

Update `loadStudyStats()` to return `StudyStats`:

```kotlin
private suspend fun loadStudyStats(): StudyStats {
    val today = LocalDate.now()
    val fromDate = today.minusDays(365)
    return withCol {
        val entries = StudyTrackingRepository.queryRevlog(db, fromDate, today)
        val dailyData = StudyTrackingRepository.getDailyStudyData(entries, fromDate, today)
        val streakInfo = StudyTrackingRepository.calculateStreak(dailyData, today)
        val todayData = dailyData[today]
        val totalTime = StudyTrackingRepository.getStudyTimeForPeriod(dailyData)
        StudyStats(
            streakInfo = streakInfo,
            todayStudyTimeMs = todayData?.studyTimeMs ?: 0L,
            todayCardsReviewed = todayData?.cardsReviewed ?: 0,
            totalStudyTimeMs = totalTime,
        )
    }
}
```

Update both callers (`loadMuseumData` and `refreshData`) to destructure `StudyStats` and set `totalStudyTimeMs` in the state update:

```kotlin
val stats = loadStudyStats()
_uiState.update {
    it.copy(
        streakDays = stats.streakInfo.currentStreak,
        graceDaysAvailable = stats.streakInfo.graceDaysAvailable,
        todayStudyTimeMs = stats.todayStudyTimeMs,
        todayCardsReviewed = stats.todayCardsReviewed,
        totalStudyTimeMs = stats.totalStudyTimeMs,
    )
}
```

**2. Create StreakBottomSheet.kt:**

Create `AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StreakBottomSheet.kt`.

Follow the pattern from `MultimediaBottomSheet.kt`: extend `BottomSheetDialogFragment`, use view binding.

```kotlin
package com.ichi2.anki.ui.museum

import android.os.Bundle
import android.view.View
import androidx.fragment.app.activityViewModels
import androidx.lifecycle.lifecycleScope
import com.google.android.material.bottomsheet.BottomSheetDialogFragment
import com.ichi2.anki.R
import com.ichi2.anki.databinding.BottomsheetStreakBinding
import dev.androidbroadcast.vbpd.viewBinding
import kotlinx.coroutines.launch

/**
 * Bottom sheet displaying the user's study streak information.
 * Shows current streak count, total study time, and grace days remaining.
 */
class StreakBottomSheet : BottomSheetDialogFragment(R.layout.bottomsheet_streak) {
    private val viewModel: MuseumViewModel by activityViewModels()
    private val binding by viewBinding(BottomsheetStreakBinding::bind)

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        viewLifecycleOwner.lifecycleScope.launch {
            viewModel.uiState.collect { state ->
                binding.streakCount.text = getString(R.string.streak_days_format, state.streakDays)
                binding.totalStudyTime.text = formatStudyTime(state.totalStudyTimeMs)
                binding.graceDaysCount.text = getString(R.string.streak_grace_days_format, state.graceDaysAvailable)
            }
        }
    }

    /**
     * Formats milliseconds into a human-readable time string.
     * - >= 60 min: "Xh Ym"
     * - >= 60 sec: "Xm"
     * - < 60 sec: "Xs"
     * - 0ms: "0m"
     */
    private fun formatStudyTime(timeMs: Long): String {
        val totalSeconds = timeMs / 1000
        val hours = totalSeconds / 3600
        val minutes = (totalSeconds % 3600) / 60
        val seconds = totalSeconds % 60

        return when {
            hours > 0 -> getString(R.string.streak_time_hours_minutes, hours.toInt(), minutes.toInt())
            minutes > 0 -> getString(R.string.streak_time_minutes, minutes.toInt())
            totalSeconds > 0 -> getString(R.string.streak_time_seconds, seconds.toInt())
            else -> getString(R.string.streak_time_minutes, 0)
        }
    }

    companion object {
        const val TAG = "StreakBottomSheet"
    }
}
```

**3. Wire StreakBottomSheet into MuseumActivity:**

In `MuseumActivity.kt`:

- Add import: `import com.ichi2.anki.ui.museum.StreakBottomSheet`

- In `setupButtons()`, add click listener for streakPill:

```kotlin
binding.streakPill.setOnClickListener {
    StreakBottomSheet().show(supportFragmentManager, StreakBottomSheet.TAG)
}
```

- In `setupObservers()`, inside the `viewModel.uiState.collect` block, add streak pill text update:

```kotlin
// Update streak pill text
binding.streakPill.text = getString(R.string.streak_pill_format, state.streakDays)
```

Add this line alongside the existing `binding.languageSelector.text = state.currentDeckName` line. It should update every time state changes.
  </action>
  <verify>
    1. `grep -c "class StreakBottomSheet" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StreakBottomSheet.kt` returns 1
    2. `grep -c "totalStudyTimeMs" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt` returns 3+ (definition + 2 update sites)
    3. `grep -c "streakPill" AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt` returns 2+ (click handler + text update)
    4. `grep -c "StreakBottomSheet" AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt` returns 2+ (import + usage)
    5. `grep "getStudyTimeForPeriod" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt` returns a match
    6. `./gradlew :AnkiDroid:assemblePlayDebug 2>&1 | tail -5` shows BUILD SUCCESSFUL
  </verify>
  <done>
    StreakBottomSheet fragment exists and displays streak count, total study time, and grace days from MuseumViewModel state. MuseumActivity wires streak pill click to show the bottom sheet. Streak pill text updates reactively with current streak count. MuseumViewModel computes and exposes totalStudyTimeMs via getStudyTimeForPeriod. Project compiles successfully.
  </done>
</task>

</tasks>

<verification>
1. Streak pill visible in toolbar: `grep "streakPill" AnkiDroid/src/main/res/layout/activity_museum.xml` returns match
2. Bottom sheet layout exists: `test -f AnkiDroid/src/main/res/layout/bottomsheet_streak.xml`
3. StreakBottomSheet class exists: `test -f AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/StreakBottomSheet.kt`
4. Click wiring: `grep "streakPill.*setOnClickListener" AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt` returns match
5. Data flow: `grep "totalStudyTimeMs" AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt` returns 3+ matches
6. Build succeeds: `./gradlew :AnkiDroid:assemblePlayDebug` completes without errors
</verification>

<success_criteria>
- STRK-01: Pill-shaped streak widget visible at top-left of homescreen toolbar with "Streak", day count, and fire icon
- STRK-02: Tapping the streak pill opens the streak bottom sheet
- STRK-03: Bottom sheet displays current streak count (consecutive days studied)
- STRK-04: Bottom sheet displays total study time formatted as hours/minutes
- Project compiles and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-streak-widget-bottom-sheet/06-01-SUMMARY.md`
</output>
