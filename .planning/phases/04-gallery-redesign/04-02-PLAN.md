---
phase: 04-gallery-redesign
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt
  - AnkiDroid/src/main/res/layout/item_gallery_page.xml
  - AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PageIndicatorHelper.kt
  - AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt
autonomous: false

must_haves:
  truths:
    - "Gallery only shows active and locked paintings (no completed paintings)"
    - "Active painting displays puzzle overlay (existing behavior preserved)"
    - "Locked paintings display as blurred and dimmed"
    - "User can swipe left/right through gallery with wrap-around"
    - "Gallery always starts on the active painting when homescreen loads"
    - "Dot indicators show current position among active and locked paintings only"
  artifacts:
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt"
      provides: "Gallery data filtering (active + locked only)"
      contains: "COMPLETED"
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt"
      provides: "Locked painting blur rendering, circular item count"
      contains: "blur"
    - path: "AnkiDroid/src/main/res/layout/item_gallery_page.xml"
      provides: "Locked painting layout with blur effect"
      contains: "lockedOverlay"
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PageIndicatorHelper.kt"
      provides: "Dot indicators for active + locked states only"
    - path: "AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt"
      provides: "Circular ViewPager2 wrap-around and initial page logic"
  key_links:
    - from: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt"
      to: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt"
      via: "galleryItems list (filtered to active + locked)"
      pattern: "galleryItems"
    - from: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt"
      to: "AnkiDroid/src/main/res/layout/item_gallery_page.xml"
      via: "ViewHolder binding for locked state blur"
      pattern: "bindLocked"
    - from: "AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt"
      to: "AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt"
      via: "Circular adapter item count for wrap-around"
      pattern: "getItemCount"
---

<objective>
Filter completed paintings out of the gallery, add blur effect to locked paintings, implement circular (wrap-around) swiping, and ensure the gallery always starts on the active painting.

Purpose: The gallery should feel like browsing an art collection with only the current masterpiece and upcoming locked paintings visible. Completed paintings belong in a future collection feature. Locked paintings teased via blur give a sense of "what's coming next."

Output: Gallery showing only active + locked paintings with blur on locked, wrap-around navigation, and proper initial positioning.
</objective>

<execution_context>
@/Users/rolandharper/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rolandharper/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gallery-redesign/04-CONTEXT.md
@.planning/phases/04-gallery-redesign/04-01-SUMMARY.md

@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt
@AnkiDroid/src/main/res/layout/item_gallery_page.xml
@AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PageIndicatorHelper.kt
@AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt
@AnkiDroid/src/main/java/com/ichi2/anki/model/art/ArtPiece.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter gallery to active + locked, add blur to locked paintings, update indicators</name>
  <files>
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/MuseumViewModel.kt
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt
    AnkiDroid/src/main/res/layout/item_gallery_page.xml
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PageIndicatorHelper.kt
  </files>
  <action>
**MuseumViewModel.kt — Filter out completed paintings:**

In `loadGalleryData()`, after the `.sortedBy` call that creates the `galleryItems` list, add a `.filter` step BEFORE the sort (or after — ordering is: active first, then locked):

```kotlin
.filter { it.state != ArtPieceState.COMPLETED }
```

This removes completed paintings from the gallery per user decision. The sort order becomes: ACTIVE (0) then LOCKED (2). Remove the `ArtPieceState.COMPLETED -> 1` case from the `sortedBy` or leave it as dead code that never matches.

Also update the `activePageIndex` calculation — it should always be 0 since active is sorted first. Remove the `savedPosition` / `getGalleryPosition` logic that restores a saved position — per user decision the gallery "always starts on the active painting when homescreen loads." Set `initialPage = 0` unconditionally (the active painting is always sorted to index 0).

**GalleryPagerAdapter.kt — Add blur to locked paintings:**

In the `bindLocked()` method, replace the current approach (simple alpha 0.3 on ImageView) with a bitmap-based blur:

1. Load the bitmap as before.
2. Apply a stack blur or Gaussian blur to the bitmap before setting it on the ImageView. Use Android's `Toolkit.blur()` (API 31+) with a fallback, OR use a simple iterative box blur on the bitmap. The simplest cross-API approach: render the bitmap at a much smaller scale (e.g., 1/8th size), scale it back up with bilinear filtering — this creates a natural blur effect without any library dependency.

Implementation for the scale-based blur:
```kotlin
private fun blurBitmap(src: Bitmap, scaleFactor: Float = 0.125f): Bitmap {
    val width = (src.width * scaleFactor).toInt().coerceAtLeast(1)
    val height = (src.height * scaleFactor).toInt().coerceAtLeast(1)
    val small = Bitmap.createScaledBitmap(src, width, height, true)
    return Bitmap.createScaledBitmap(small, src.width, src.height, true)
}
```

Add this as a private method in `GalleryPagerAdapter`. In `bindLocked()`, after loading the bitmap, apply the blur and set it on `lockedImage`. Set the alpha to 0.5 (50% dimming) instead of the current 0.3 for a more visible but still teasing preview.

Remove the lock icon overlay from the locked state — per the context, locked paintings should be "blurred/dimmed" without an explicit lock indicator. The blur itself communicates the locked state.

**item_gallery_page.xml — Simplify locked overlay:**

In the `lockedOverlay` FrameLayout:
1. Remove the inner LinearLayout containing the lock icon ImageView and "Locked" TextView. The blur effect on the image alone communicates the locked state.
2. Keep the `lockedImage` ImageView. Change its `android:alpha` from `0.3` to `0.5` (the dimming will combine with the blur applied in code).
3. Optionally keep a subtle semi-transparent dark overlay on top for extra dimming — add a View with `android:background="#40000000"` matching the image size, or just rely on the alpha.

The simplified locked overlay should be:
```xml
<FrameLayout
    android:id="@+id/lockedOverlay"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:visibility="gone">

    <ImageView
        android:id="@+id/lockedImage"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:adjustViewBounds="true"
        android:scaleType="fitCenter"
        android:alpha="0.5"
        android:contentDescription="@string/art_locked" />
</FrameLayout>
```

**PageIndicatorHelper.kt — Remove COMPLETED state:**

The `COMPLETED` case in both `setupIndicators()` and `updateCurrentPage()` will never trigger since completed items are filtered out. Remove the `ArtPieceState.COMPLETED -> drawable.setColor(COLOR_GREEN)` branch from both methods. Simplify: ACTIVE dots use amber fill, LOCKED dots use hollow gray stroke (current behavior).

Also remove the `COLOR_GREEN` constant since it's no longer used.
  </action>
  <verify>
Run `./gradlew assemblePlayDebug` — build must succeed. Grep for `ArtPieceState.COMPLETED` in `MuseumViewModel.kt` — the filter should exclude them. Grep for `blurBitmap\|createScaledBitmap` in `GalleryPagerAdapter.kt` — should find the blur helper. Verify `item_gallery_page.xml` no longer contains `ic_lock_lock`.
  </verify>
  <done>
Gallery items list contains only ACTIVE and LOCKED paintings. Locked paintings render with a blur + dimming effect. Page indicator dots only show active (amber) and locked (hollow gray) states. Completed paintings are excluded entirely.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement circular wrap-around and always-start-on-active</name>
  <files>
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/GalleryPagerAdapter.kt
    AnkiDroid/src/main/java/com/ichi2/anki/MuseumActivity.kt
    AnkiDroid/src/main/java/com/ichi2/anki/ui/museum/PageIndicatorHelper.kt
  </files>
  <action>
**Circular ViewPager2 — wrap-around swiping:**

The standard approach for circular/infinite ViewPager2: override `getItemCount()` to return a very large number (e.g., `items.size * 1000` or `Int.MAX_VALUE` if items is non-empty), then use modular arithmetic to map virtual positions to real positions.

In `GalleryPagerAdapter.kt`:
1. Override `getItemCount()`: return `if (items.isEmpty()) 0 else items.size * MULTIPLIER` where `MULTIPLIER = 1000`. This gives enough room to swipe in both directions.
2. In `onBindViewHolder()`, use `position % items.size` to get the real index:
   ```kotlin
   override fun onBindViewHolder(holder: GalleryViewHolder, position: Int) {
       holder.bind(items[position % items.size])
   }
   ```
3. Add a helper method `fun getRealPosition(virtualPosition: Int): Int = if (items.isEmpty()) 0 else virtualPosition % items.size` for external callers.
4. Add a helper `fun getStartPosition(): Int` that returns the virtual position to start at — this should be at the middle of the virtual range, on the active item (index 0). Calculate: `(MULTIPLIER / 2) * items.size`. This positions the user in the middle so they can swipe left and right freely.
5. In `updateActivePainting()`, update `notifyItemChanged` to work with the virtual range — OR use `notifyDataSetChanged()` since active painting updates are infrequent.

In `MuseumActivity.kt`:
1. In `setupObservers()` where `setCurrentItem` is called, use `galleryAdapter.getStartPosition()` instead of `state.activePageIndex`:
   ```kotlin
   val startPos = galleryAdapter.getStartPosition()
   binding.galleryPager.setCurrentItem(startPos, false)
   ```
   Ensure this only runs once on initial load (not on every state update). Use a flag like `private var hasSetInitialPage = false` to guard it.

2. In the `onPageSelected` callback, convert the virtual position to real:
   ```kotlin
   override fun onPageSelected(position: Int) {
       val realPos = galleryAdapter.getRealPosition(position)
       val items = viewModel.uiState.value.galleryItems
       if (realPos in items.indices) {
           val item = items[realPos]
           binding.captionText.text = item.artPiece.title
           binding.artistText.text = item.artPiece.artist ?: ""
           PageIndicatorHelper.updateCurrentPage(
               binding.pageIndicator,
               items,
               realPos,
           )
       }
   }
   ```

3. Remove the `MuseumPersistence.setGalleryPosition()` call from `onPageSelected` — we no longer persist gallery position since we always start on active.

4. In the `setupObservers` uiState collector, update the `PageIndicatorHelper.setupIndicators` call to use `realPos`:
   ```kotlin
   val currentRealPos = galleryAdapter.getRealPosition(binding.galleryPager.currentItem)
   PageIndicatorHelper.setupIndicators(binding.pageIndicator, state.galleryItems, currentRealPos)
   ```

**PageIndicatorHelper — no changes needed** beyond what was done in Task 1 (COMPLETED removal). The indicators already work with real positions.

**MuseumPersistence — remove getGalleryPosition/setGalleryPosition calls:**
Remove the calls in MuseumActivity.kt only. Don't modify MuseumPersistence.kt itself (other code may use it).
  </action>
  <verify>
Run `./gradlew assemblePlayDebug` — build must succeed. Grep for `getStartPosition\|getRealPosition\|MULTIPLIER` in `GalleryPagerAdapter.kt` — should find all three. Grep for `getGalleryPosition\|setGalleryPosition` in `MuseumActivity.kt` — should find zero matches (calls removed). Verify `getItemCount` returns `items.size * MULTIPLIER` (not just `items.size`).
  </verify>
  <done>
Gallery wraps around when swiping past the last painting (loops to first) and past the first (loops to last). Gallery always opens on the active painting at the center of the virtual range. Dot indicators correctly show the real position. Gallery position is no longer persisted.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify gallery redesign on device</name>
  <files>None (visual verification only)</files>
  <action>
Build and install the app on a connected device or emulator: `./gradlew installPlayDebug`

What was built: Complete gallery redesign — heatmap removed, stats removed, painting expanded to fill lower homescreen, title/artist displayed below painting, only active + locked paintings in gallery, locked paintings blurred/dimmed, circular wrap-around swiping, gallery starts on active painting, dot indicators updated.

Verification steps:
1. Open the app — homescreen should show:
   - Top nav bar (deck selector, "MuseoLingo" title, menu button)
   - Large painting area with puzzle overlay (active painting)
   - Page dots below painting
   - Painting title + artist name below dots
   - "Review Cards" button at bottom
2. Verify REMOVED elements:
   - No heatmap (year grid, "2026" header, review count subheader)
   - No streak/today's cards stats row
3. Swipe left through gallery — should see locked paintings (blurred/dimmed, no lock icon)
4. Swipe past the last painting — should wrap around to the first (active) painting
5. Swipe right from the active painting — should wrap to the last locked painting
6. Verify dot indicators update correctly when swiping
7. Close and reopen app — should start on the active painting every time
8. Verify painting has rounded corners (card/frame feel) with visible padding around it
  </action>
  <verify>Human visual inspection on device confirms all 8 verification steps pass.</verify>
  <done>User approves the gallery redesign visuals and interaction on device. Type "approved" to continue, or describe any issues to fix.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `./gradlew assemblePlayDebug`
2. Gallery items filtered: completed paintings excluded from `galleryItems` list
3. Locked paintings blurred: `bindLocked()` applies scale-based blur
4. Circular navigation: `getItemCount()` returns `items.size * MULTIPLIER`
5. Start on active: `getStartPosition()` returns middle of virtual range at active index
6. No heatmap references in Activity
7. Title + artist displayed below painting
</verification>

<success_criteria>
- Gallery shows only active (with puzzle) and locked (blurred) paintings
- Swiping wraps around in both directions
- Gallery starts on active painting every time
- Dot indicators correctly reflect current position among real items
- Human verification confirms visual correctness on device
</success_criteria>

<output>
After completion, create `.planning/phases/04-gallery-redesign/04-02-SUMMARY.md`
</output>
